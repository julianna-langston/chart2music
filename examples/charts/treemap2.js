import { c2mChart } from "../../dist/index.mjs";

const sortByY = (a, b) => {
    if (a[1] < b[1]) {
        return 1;
    }
    if (a[1] > b[1]) {
        return -1;
    }
    return 0;
};

const tree = [
    {
        state: "Alabama",
        code: "AL",
        region: "South",
        division: "East South Central",
        income: 48123,
        population: 4887871,
        area: 135767
    },
    {
        state: "Alaska",
        code: "AK",
        region: "West",
        division: "Pacific",
        income: 73181,
        population: 737438,
        area: 1723337
    },
    {
        state: "Arizona",
        code: "AZ",
        region: "West",
        division: "Mountain",
        income: 56581,
        population: 7171646,
        area: 295234
    },
    {
        state: "Arkansas",
        code: "AR",
        region: "South",
        division: "West South Central",
        income: 45869,
        population: 3013825,
        area: 137732
    },
    {
        state: "California",
        code: "CA",
        region: "West",
        division: "Pacific",
        income: 71805,
        population: 39557045,
        area: 423972
    },
    {
        state: "Colorado",
        code: "CO",
        region: "West",
        division: "Mountain",
        income: 69117,
        population: 5695564,
        area: 269601
    },
    {
        state: "Connecticut",
        code: "CT",
        region: "Northeast",
        division: "New England",
        income: 74168,
        population: 3572665,
        area: 14357
    },
    {
        state: "Delaware",
        code: "DE",
        region: "South",
        division: "South Atlantic",
        income: 62852,
        population: 967171,
        area: 6446
    },
    {
        state: "District of Columbia",
        code: "DC",
        region: "South",
        division: "South Atlantic",
        income: 82372,
        population: 702455,
        area: 177
    },
    {
        state: "Florida",
        code: "FL",
        region: "South",
        division: "South Atlantic",
        income: 52594,
        population: 21299325,
        area: 170312
    },
    {
        state: "Georgia",
        code: "GA",
        region: "South",
        division: "South Atlantic",
        income: 56183,
        population: 10519475,
        area: 153910
    },
    {
        state: "Hawaii",
        code: "HI",
        region: "West",
        division: "Pacific",
        income: 77765,
        population: 1420491,
        area: 28313
    },
    {
        state: "Idaho",
        code: "ID",
        region: "West",
        division: "Mountain",
        income: 52225,
        population: 1754208,
        area: 216443
    },
    {
        state: "Illinois",
        code: "IL",
        region: "Midwest",
        division: "East North Central",
        income: 62992,
        population: 12741080,
        area: 149995
    },
    {
        state: "Indiana",
        code: "IN",
        region: "Midwest",
        division: "East North Central",
        income: 54181,
        population: 6691878,
        area: 94326
    },
    {
        state: "Iowa",
        code: "IA",
        region: "Midwest",
        division: "West North Central",
        income: 5857,
        population: 3156145,
        area: 145746
    },
    {
        state: "Kansas",
        code: "KS",
        region: "Midwest",
        division: "West North Central",
        income: 56422,
        population: 2911505,
        area: 213100
    },
    {
        state: "Kentucky",
        code: "KY",
        region: "South",
        division: "East South Central",
        income: 45215,
        population: 4468402,
        area: 104656
    },
    {
        state: "Louisiana",
        code: "LA",
        region: "South",
        division: "West South Central",
        income: 46145,
        population: 4659978,
        area: 135659
    },
    {
        state: "Maine",
        code: "ME",
        region: "Northeast",
        division: "New England",
        income: 55277,
        population: 1338404,
        area: 91633
    },
    {
        state: "Maryland",
        code: "MD",
        region: "South",
        division: "South Atlantic",
        income: 80776,
        population: 6042718,
        area: 32131
    },
    {
        state: "Massachusetts",
        code: "MA",
        region: "Northeast",
        division: "New England",
        income: 77385,
        population: 6902149,
        area: 27336
    },
    {
        state: "Michigan",
        code: "MI",
        region: "Midwest",
        division: "East North Central",
        income: 54909,
        population: 9995915,
        area: 250487
    },
    {
        state: "Minnesota",
        code: "MN",
        region: "Midwest",
        division: "West North Central",
        income: 68388,
        population: 5611179,
        area: 225163
    },
    {
        state: "Mississippi",
        code: "MS",
        region: "South",
        division: "East South Central",
        income: 43529,
        population: 2986530,
        area: 125438
    },
    {
        state: "Missouri",
        code: "MO",
        region: "Midwest",
        division: "West North Central",
        income: 53578,
        population: 6126452,
        area: 180540
    },
    {
        state: "Montana",
        code: "MT",
        region: "West",
        division: "Mountain",
        income: 53386,
        population: 1062305,
        area: 380831
    },
    {
        state: "Nebraska",
        code: "NE",
        region: "Midwest",
        division: "West North Central",
        income: 59970,
        population: 1929268,
        area: 200330
    },
    {
        state: "Nevada",
        code: "NV",
        region: "West",
        division: "Mountain",
        income: 58003,
        population: 3034392,
        area: 286380
    },
    {
        state: "New Hampshire",
        code: "NH",
        region: "Northeast",
        division: "New England",
        income: 73381,
        population: 1356458,
        area: 24214
    },
    {
        state: "New Jersey",
        code: "NJ",
        region: "Northeast",
        division: "Middle Atlantic",
        income: 80088,
        population: 8908520,
        area: 22591
    },
    {
        state: "New Mexico",
        code: "NM",
        region: "West",
        division: "Mountain",
        income: 46744,
        population: 2095428,
        area: 314917
    },
    {
        state: "New York",
        code: "NY",
        region: "Northeast",
        division: "Middle Atlantic",
        income: 64894,
        population: 19542209,
        area: 141297
    },
    {
        state: "North Carolina",
        code: "NC",
        region: "South",
        division: "South Atlantic",
        income: 52752,
        population: 10383620,
        area: 139391
    },
    {
        state: "North Dakota",
        code: "ND",
        region: "Midwest",
        division: "West North Central",
        income: 61843,
        population: 760077,
        area: 183108
    },
    {
        state: "Ohio",
        code: "OH",
        region: "Midwest",
        division: "East North Central",
        income: 54021,
        population: 11689442,
        area: 116098
    },
    {
        state: "Oklahoma",
        code: "OK",
        region: "South",
        division: "West South Central",
        income: 50051,
        population: 3943079,
        area: 181037
    },
    {
        state: "Oregon",
        code: "OR",
        region: "West",
        division: "Pacific",
        income: 60212,
        population: 4190713,
        area: 254799
    },
    {
        state: "Pennsylvania",
        code: "PA",
        region: "Northeast",
        division: "Middle Atlantic",
        income: 59105,
        population: 12807060,
        area: 119280
    },
    {
        state: "Rhode Island",
        code: "RI",
        region: "Northeast",
        division: "New England",
        income: 63870,
        population: 1057315,
        area: 4001
    },
    {
        state: "South Carolina",
        code: "SC",
        region: "South",
        division: "South Atlantic",
        income: 50570,
        population: 5084127,
        area: 82933
    },
    {
        state: "South Dakota",
        code: "SD",
        region: "Midwest",
        division: "West North Central",
        income: 56521,
        population: 882235,
        area: 199729
    },
    {
        state: "Tennessee",
        code: "TN",
        region: "South",
        division: "East South Central",
        income: 51340,
        population: 6770010,
        area: 109153
    },
    {
        state: "Texas",
        code: "TX",
        region: "South",
        division: "West South Central",
        income: 59206,
        population: 28701845,
        area: 695662
    },
    {
        state: "Utah",
        code: "UT",
        region: "West",
        division: "Mountain",
        income: 65358,
        population: 3161105,
        area: 219882
    },
    {
        state: "Vermont",
        code: "VT",
        region: "Northeast",
        division: "New England",
        income: 57513,
        population: 626299,
        area: 24906
    },
    {
        state: "Virginia",
        code: "VA",
        region: "South",
        division: "South Atlantic",
        income: 71535,
        population: 8517685,
        area: 110787
    },
    {
        state: "Washington",
        code: "WA",
        region: "West",
        division: "Pacific",
        income: 70979,
        population: 7535591,
        area: 184661
    },
    {
        state: "West Virginia",
        code: "WV",
        region: "South",
        division: "South Atlantic",
        income: 43469,
        population: 1805832,
        area: 62756
    },
    {
        state: "Wisconsin",
        code: "WI",
        region: "Midwest",
        division: "East North Central",
        income: 59305,
        population: 5813568,
        area: 169635
    },
    {
        state: "Wyoming",
        code: "WY",
        region: "West",
        division: "Mountain",
        income: 60434,
        population: 577737,
        area: 253335
    }
];
const key = "area";
const groups = ["region", "division", "state"];
const capitalizeFirstLetter = (string) =>
    string.charAt(0).toUpperCase() + string.slice(1);

let c2mData = {};
let xLabels = [];
const generateC2MTreeData = (name, tree, groups) => {
    const collector = groups.shift();
    const table = {};

    tree.forEach((node) => {
        table[node[collector]] ??= 0;
        table[node[collector]] += node[key];
    });

    c2mData[name] = Object.entries(table)
        .sort(sortByY)
        .map(([label, y]) => {
            if (!xLabels.includes(label)) {
                xLabels.push(label);
            }
            return {
                x: xLabels.indexOf(label),
                y
            };
        })
        .sort(sortByY);

    if (groups.length === 0) {
        return;
    }

    const keys = Object.keys(table);
    keys.forEach((k) => {
        generateC2MTreeData(
            k,
            tree.filter((node) => node[collector] === k),
            groups.slice(0)
        );
    });
};

generateC2MTreeData("Region", tree, groups.slice(0));

const buffs = {
    Region: 0
};

export const treemap2 = (canvas, cc) => {
    const config = {
        type: "treemap",
        data: {
            datasets: [
                {
                    tree,
                    key,
                    groups,
                    spacing: 1,
                    borderWidth: 0.5,
                    borderColor: "rgba(200,200,200,1)",
                    backgroundColor: "rgba(220,230,220,0.3)",
                    hoverBackgroundColor: "rgba(220,230,220,0.5)",
                    captions: {
                        align: "center",
                        display: true,
                        color: "red",
                        font: {
                            size: 14
                        },
                        hoverFont: {
                            size: 16,
                            weight: "bold"
                        },
                        padding: 5
                    },
                    labels: {
                        display: false,
                        overflow: "hidden"
                    }
                }
            ]
        },
        options: {
            plugins: {
                title: {
                    display: true,
                    text: () => "US area by " + groups.join(" / ")
                },
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title(items) {
                            return capitalizeFirstLetter(items[0].dataset.key);
                        },
                        label(item) {
                            const dataItem = item.raw;
                            const obj = dataItem._data;
                            const label =
                                obj.state || obj.division || obj.region;
                            return label + ": " + dataItem.v;
                        }
                    }
                }
            }
        }
    };

    const myChart = new Chart(canvas, config);

    const { err, data: c2m } = c2mChart({
        type: "treemap",
        axes: {
            x: {
                valueLabels: xLabels
            },
            y: {
                label: "Area",
                format: (value) => value.toLocaleString() + " km2"
            }
        },
        title: config.options.plugins.title.text(),
        element: canvas,
        cc,
        data: c2mData,
        options: {
            onFocusCallback: ({ slice, index }) => {
                const toHighlight = [
                    { datasetIndex: 0, index: index + buffs[slice] }
                ];
                myChart.setActiveElements(toHighlight);
                myChart?.tooltip?.setActiveElements(toHighlight, {});
                myChart.update();
            }
        }
    });
    if (err) {
        console.error(err);
    }

    console.log(c2m);
};
